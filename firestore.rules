rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    // 1. Check if user is signed in
    function isAuthenticated() {
      return request.auth != null;
    }

    // 2. Check if user is accessing their own document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // 3. Check for specific Role (Stored in User Doc)
    function hasRole(role) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    // 4. Super Admin Override
    function isSuperAdmin() {
      return hasRole('super_admin');
    }

    // --- Collection Rules ---

    // USERS Collection
    match /users/{userId} {
      allow read, write: if isOwner(userId) || isSuperAdmin();
    }
    match /users/{userId}/checkins/{checkinId} {
        allow read, write: if isAuthenticated();
    }

    // GYMS Collection
    match /gyms/{gymId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isSuperAdmin(); 
    }

    // FEED & SOCIAL
    match /feed_activities/{activityId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.userId) || isSuperAdmin();
    }
    match /notifications/{id} { 
      allow read, write: if isAuthenticated();
    }

    // GYM MANAGEMENT
    match /enquiries/{enquiryId} {
      allow read, write: if isAuthenticated();
    }
    match /partner_plans/{planId} {
       allow read: if true;
       allow write: if hasRole('gym_owner') || isSuperAdmin();
    }

    // CORE APP DATA (Permissive for Verification)
    match /transactions/{id} { allow read, write: if isAuthenticated(); }
    match /achievements/{id} { allow read, write: if isAuthenticated(); }
    match /live_sessions/{id} { allow read, write: if isAuthenticated(); }
    match /challenges/{id} { allow read, write: if isAuthenticated(); }
    match /ratings/{id} { allow read, write: if isAuthenticated(); }
    match /products/{id} { allow read, write: if true; }
    match /audit_logs/{id} { allow read, write: if isAuthenticated(); }
  }
}
